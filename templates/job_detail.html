{% extends "layout.html" %}

{% block content %}
<div class="job-header">
    <div class="header-actions">
        <div class="breadcrumbs">
            <a href="/">Dashboard</a> <i class="fa-solid fa-chevron-right"
                style="font-size: 0.7rem; margin: 0 0.5rem;"></i> {{ job.title }}
        </div>
        <h1>{{ job.title }}</h1>
    </div>
    <div class="action-buttons">
        <button onclick="triggerUpload()" class="btn-primary">
            <i class="fa-solid fa-upload"></i> Upload Candidates
        </button>
        <a href="/jobs/{{ job.id }}/export" class="btn-secondary" style="text-decoration:none;">
            <i class="fa-solid fa-file-export"></i> Export CSV
        </a>
    </div>
</div>

<!-- Upload Form Hidden -->
<form id="uploadCvsForm" action="/jobs/{{ job.id }}/upload" method="POST" enctype="multipart/form-data" class="hidden">
    <input type="file" id="cvsInput" name="cvs" multiple onchange="this.form.submit()">
</form>

<div class="filter-toolbar glass-card"
    style="padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center;">
    <span style="font-weight: 600; color: var(--text-primary);"><i class="fa-solid fa-filter"></i> Filters:</span>
    <form action="" method="GET" style="display: flex; gap: 1rem; flex: 1; align-items: center;">

        <select name="status_filter" style="padding: 0.5rem; border-radius: var(--radius);">
            <option value="">All Statuses</option>
            <option value="Applied" {% if request.args.get('status_filter')=='Applied' %}selected{% endif %}>Applied
                Only</option>
            <option value="Screening" {% if request.args.get('status_filter')=='Screening' %}selected{% endif %}>
                Screening Only</option>
            <option value="Interview" {% if request.args.get('status_filter')=='Interview' %}selected{% endif %}>
                Interview Only</option>
            <option value="Offer" {% if request.args.get('status_filter')=='Offer' %}selected{% endif %}>Offer Only
            </option>
        </select>

        <input type="number" name="min_score" placeholder="Min Score (0-100)"
            value="{{ request.args.get('min_score', '') }}"
            style="width: 150px; padding: 0.5rem; border-radius: var(--radius);">

        <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem;">Apply</button>

        {% if request.args.get('min_score') or request.args.get('status_filter') %}
        <a href="{{ url_for('core.job_detail', job_id=job.id) }}" class="btn-secondary"
            style="font-size: 0.9rem;">Clear</a>
        {% endif %}
    </form>
</div>

<div class="candidates-section">
    {% if candidates %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Candidate</th>
                    <th>Match Score</th>
                    <th>Status</th>
                    <th>Skill Gaps</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cand in candidates %}
                <tr class="candidate-row" onclick="viewCandidate({{ cand.id }})">
                    <td style="font-weight: 700; color: #a855f7;">#{{ loop.index }}</td>
                    <td>
                        <div class="cand-name" style="font-weight: 600;">{{ cand.filename }}</div>
                        <div class="cand-meta" style="font-size: 0.8rem; color: var(--text-muted);">Added {{
                            cand.created_at[:10] }}</div>
                    </td>
                    <td>
                        <div class="score-circle"
                            style="--p:{{ cand.total_score }}; --c:{% if cand.total_score > 75 %}#10b981{% elif cand.total_score > 50 %}#f59e0b{% else %}#ef4444{% endif %}">
                            <span>{{ cand.total_score|round|int }}%</span>
                        </div>
                    </td>
                    <td onclick="event.stopPropagation()">
                        <form action="/candidate/{{ cand.id }}/status" method="POST">
                            <select name="status" onchange="this.form.submit()"
                                style="padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); cursor: pointer;">
                                <option value="Applied" {% if cand.status=='Applied' %}selected{% endif %}>Applied
                                </option>
                                <option value="Screening" {% if cand.status=='Screening' %}selected{% endif %}>Screening
                                </option>
                                <option value="Interview" {% if cand.status=='Interview' %}selected{% endif %}>Interview
                                </option>
                                <option value="Offer" {% if cand.status=='Offer' %}selected{% endif %}>Offer</option>
                                <option value="Rejected" {% if cand.status=='Rejected' %}selected{% endif %}>Rejected
                                </option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <span class="tag missing" style="font-size: 0.75rem; cursor: pointer;">View Analysis</span>
                    </td>
                    <td>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteCandidate({{ cand.id }})"><i
                                class="fa-solid fa-trash text-red"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="glass-card empty-state" style="text-align: center; padding: 4rem 2rem;">
        <div class="icon-box purple" style="margin: 0 auto 1.5rem; width: 80px; height: 80px; font-size: 2.5rem;">
            <i class="fa-solid fa-cloud-arrow-up"></i>
        </div>
        <h3 style="margin-bottom: 0.5rem;">No candidates yet</h3>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">Upload CVs to start the AI screening process.</p>
        <button onclick="triggerUpload()" class="btn-secondary">Upload CVs Now</button>
    </div>
    {% endif %}
</div>
{% endblock %}